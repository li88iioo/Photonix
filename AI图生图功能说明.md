# AI密语图生图功能使用说明

## 功能概述

AI密语现已支持图生图功能！在聊天时可以请求AI生成图片，系统会通过视觉模型提取当前图片细节，并使用生图API生成新的图片。

## 环境配置

在启动应用前，需要配置以下环境变量：

```bash
# AI图片生成服务配置
AI_IMAGE_GEN_URL=https://api.example.com/v1/generate  # 完整的生图API地址（包含/v1/generate）
AI_IMAGE_GEN_KEY=your_api_key_here                    # 生图API密钥（Bearer Token）
AI_IMAGE_GEN_MODEL=your_model_name_here                # 指定生图模型名称
AI_IMAGE_GEN_TIMEOUT_MS=180000                        # 生图超时时间（可选，默认3分钟）
```

### 功能启用/禁用

- **启用条件**：必须同时配置 `AI_IMAGE_GEN_URL` 和 `AI_IMAGE_GEN_KEY`
- **未配置时的行为**：
  - 前端不会检测图片请求关键词
  - 所有消息都走普通聊天流程
  - 不会出现任何图片生成相关的提示或错误
- **状态查询API**：`GET /api/ai/image-gen-status` 返回功能是否可用

> **注意**：这是一个过渡性功能（视觉提取 → 文生图），未来会实现真正的图生图（基于上下文直接生成）。如不需要此功能，只需不配置上述环境变量即可。



### 1. 触发图片生成

在AI密语聊天框中，发送包含以下关键词的消息即可触发图片生成：

#### 基础触发词
- **询问类**: "看看你"、"你在干嘛"、"在干嘛"、"你现在"、"你的样子"
- **穿搭类**: "穿搭"、"衣服"、"裙子"、"裤子"、"今天穿"
- **拍照类**: "自拍"、"照片"、"图片"、"发张"、"来张"

#### 上下文修改触发词（对话式生图）
- **修改指令**: "换一"、"换个"、"换成"、"改成"、"变成"
- **姿势类**: "姿势"、"站着"、"坐着"、"躺着"、"回头"
- **表情类**: "笑"、"看镜头"、"看远方"、"严肃"、"调皮"、"开心"
- **场景类**: "场景"、"背景"、"去海边"、"去"、"在卧室"、"在客厅"、"户外"
- **视角类**: "角度"、"近一点"、"远一点"、"上半身"、"全身"

### 🎯 上下文对话式生图（新功能）

支持根据对话上下文和用户指令动态生成图片：

**基础生成：**
```
用户: 看看你在干嘛
AI: [生成基础图片]
```

**连续指令生成：**
```
用户: 看看你在干嘛
AI: [生成图片1]

用户: 换一件衣服
AI: [生成图片2 - 保持环境/姿势，改变衣服]

用户: 换个姿势
AI: [生成图片3 - 保持环境/衣服，改变姿势]

用户: 笑一个
AI: [生成图片4 - 添加微笑表情]
```

**支持的指令类型：**
- **换衣服**: "换一件衣服"、"换件裙子"
- **换姿势**: "换个姿势"、"站着"、"坐着"
- **换场景**: "换个场景"、"去海边"、"在卧室"
- **表情变化**: "笑一个"、"看镜头"
- **其他调整**: "换个角度"、"近一点"

### 2. 友好提醒

发送请求后，AI会随机显示一条友好提醒消息：

- "我正在整理妆容，等一会哦～"
- "让我找找最近的照片～"
- "稍等，正在拍照～"
- "等我换个角度拍给你看～"
- "马上就好，别着急～"
- "让我准备一下～"
- "正在整理衣服呢～"
- "等我换一下～"
- "让我摆个pose～"
- "稍等一下就好～"

### 3. 生成流程

1. **用户发送请求** → 如"看看你在干嘛" 或 "换一件衣服"
2. **显示友好提醒** → 显示随机提醒消息（带loading动画）
3. **智能视觉提取** → 后端使用视觉模型分析当前图片 + 理解用户指令
4. **生成定制prompt** → 结合图片细节和用户要求生成精准的绘图提示词
5. **调用生图API** → 使用定制的prompt调用生图服务
6. **返回图片** → loading消息被替换为生成的图片

## 技术架构

### 后端实现（支持上下文指令）

```
用户请求（如"换一件衣服"）
         ↓
    图片请求检测
         ↓
    视觉模型分析当前图片
         ↓
    智能理解用户指令（"换一件衣服"）
         ↓
    生成定制prompt（保持姿势/环境，改变衣服）
         ↓
    调用生图API
         ↓
    返回新图片URL
```

**核心文件：**
- `backend/services/ai-image-generation.js` - 图片生成服务
- `backend/controllers/ai.controller.js` - 控制器（新增generateImageFromChat方法）
- `backend/routes/ai.routes.js` - 路由（新增/api/ai/generate-image）
- `backend/config/index.js` - 配置管理

### 前端实现

**核心文件：**
- `frontend/js/api/ai.js` - API调用与请求处理
- `frontend/js/features/ai/ai-conversation-store.js` - 消息类型扩展
- `frontend/assets/css/style.css` - 图片消息样式

**消息类型：**
```javascript
MESSAGE_TYPE = {
    TEXT: 'text',      // 普通文本消息
    IMAGE: 'image',    // 图片消息
    LOADING: 'loading' // 加载状态消息
}
```

## API接口

### POST /api/ai/generate-image

**请求体：**
```json
{
  "image_path": "/path/to/current/image.jpg",
  "visionConfig": {
    "url": "https://api.openai.com/v1",
    "key": "sk-xxxxx",
    "model": "gpt-4-vision"
  },
  "userInstruction": "换一件衣服"  // 可选，用户的特殊指令
}
```

**成功响应：**
```json
{
  "success": true,
  "imageUrl": "https://generated-image-url.com/image.png",
  "prompt": "详细的生成prompt...",
  "generatedAt": "2025-12-03T10:30:00Z",
  "requestId": "req_xxxxx"
}
```

**错误响应：**
```json
{
  "code": "IMAGE_GENERATION_FAILED",
  "message": "图片生成失败: 具体错误信息",
  "requestId": "req_xxxxx"
}
```

## 视觉提取Prompt模板

系统使用完整的视觉提取prompt模板，确保：

1. **1:1视觉还原** - 100%还原背景、构图、光影
2. **人物检测与重塑** - 自动检测人物姿态和服装
3. **细节注入** - 添加皮肤质感、光影效果等细节
4. **格式规范** - 输出符合生图模型要求的中文prompt


## 样式预览

### 图片消息样式
- 最大宽度: 280px（桌面）/ 220px（移动端）
- 圆角: 12px
- 悬停效果: 1.02倍缩放
- 半透明边框与模糊背景

### Loading动画
- 点状loading: "..." 动画循环
- 半透明气泡样式
- 与整体UI风格统一

## 性能优化

1. **并发控制** - 继承AI微服务的并发限制（最大3个）
2. **超时管理** - 默认3分钟超时（可配置）
3. **错误处理** - 完善的错误提示与重试机制
4. **消息持久化** - 图片消息存储在IndexedDB中

## 安全措施

1. **路径验证** - 防止路径遍历攻击
2. **速率限制** - 继承全局rateLimiter + AI专用aiRateGuard
3. **输入校验** - Joi schema严格校验
4. **HTTPS通信** - 支持HTTPS API调用

## 故障排查

### 问题1: 提示"图片生成服务未配置"
**解决方案：** 检查环境变量 `AI_IMAGE_GEN_URL` 和 `AI_IMAGE_GEN_KEY` 是否已设置

### 问题2: 生图超时
**解决方案：** 调整 `AI_IMAGE_GEN_TIMEOUT_MS` 环境变量，增加超时时间

### 问题3: 图片请求未被识别
**解决方案：** 检查消息是否包含关键词，或在 `frontend/js/api/ai.js` 中添加新的关键词

### 问题4: 图片无法显示
**解决方案：**
- 检查生图API返回的URL是否可访问
- 检查浏览器控制台是否有CORS错误
- 确认返回的是有效的图片URL或base64数据

## 日志调试

开启调试日志：
```bash
LOG_LEVEL=debug node backend/server.js
```

关键日志标识：
- `[AI-ImageGen]` - 图片生成服务日志
- `[AI-MICROSERVICE]` - AI微服务日志

## 扩展开发

### 添加新的触发关键词

编辑 `frontend/js/api/ai.js` (约383-409行):
```javascript
function detectImageRequest(message) {
    const imageKeywords = [
        // 询问类
        '看看你', '你在干嘛', '你在做什么', '在干嘛',
        '看看你的', '你现在', '你的样子',

        // 穿搭类
        '穿搭', '衣服', '今天穿', '你的搭配', '裙子', '裤子',

        // 拍照类
        '自拍', '照片', '图片', '发张', '来张',

        // 修改类（支持上下文对话）
        '换一', '换个', '换成', '改成', '变成',

        // 姿势类
        '姿势', '站着', '坐着', '躺着', '回头',

        // 表情类
        '笑', '看镜头', '看远方', '严肃', '调皮', '开心',

        // 场景类
        '场景', '背景', '去海边', '去', '在卧室', '在客厅', '户外',

        // 视角类
        '角度', '近一点', '远一点', '上半身', '全身',

        '你的新关键词'  // 在这里添加新关键词
    ];
    return imageKeywords.some(keyword => message.includes(keyword));
}
```

### 添加新的友好提醒

编辑 `frontend/js/api/ai.js` (约412-424行):
```javascript
const FRIENDLY_REMINDERS = [
    '我正在整理妆容，等一会哦～',
    '让我找找最近的照片～',
    '稍等，正在拍照～',
    '等我换个角度拍给你看～',
    '马上就好，别着急～',
    '让我准备一下～',
    '正在整理衣服呢～',
    '等我换一下～',
    '让我摆个pose～',
    '稍等一下就好～',
    '你的自定义提醒～'  // 在这里添加新提醒
];
```

### 自定义Prompt模板

编辑 `backend/services/ai-image-generation.js` 中的 `VISION_EXTRACTION_PROMPT` 常量。


