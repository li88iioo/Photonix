# 常见问题与故障排查 (Troubleshooting)

本文档整理了 Photonix 在部署、性能及功能使用中的常见问题及解决方案。

---

## 🚧 部署与配置问题

### 1. 项目无法启动 / 容器循环重启
- **核查内容**：
    - 是否已在 `.env` 中配置 `JWT_SECRET`（出于安全考虑，必须手动设置）。
    - 检查端口冲突：确保 `12080` (Web), `13001` (AI Service), `6379` (Redis) 未被占用。
    - 运行 `docker compose logs -f` 查看报错信息。

### 2. 照片目录挂载后仍然一片空白
- **权限核查**：检查照片目录的挂载路径与容器内权限。
- **属主修复**：
    - **Linux 主机**：容器进程默认以 UID 1000 (node) 运行。请执行：
      `sudo chown -R 1000:1000 /your/photo/path`
    - **NAS/NFS (如群晖 DSM)**：在 DSM 中创建专用用户并赋予照片目录读写权限，或在 `docker-compose.yml` 中添加 `user: "UID:GID"` 强制指定运行用户。
- **触发扫描**：确保已在管理员面板点击“立即重建索引”。

### 3. Redis 缓存连接异常
- **核查**：确认 Redis 容器是否正常运行。
- **配置**：检查 `.env` 中的 `REDIS_URL` 是否正确（Docker 环境下通常为 `redis://redis:6379`）。

---

## ⚡ 性能调优

### 4. 接口频繁返回 429 (Too Many Requests)
- **解决**：说明您的并发操作频率超过了安全阈值。
- **调整**：在 `.env` 中调大速率限制参数或管理员 API 密钥的频率限制。

### 5. 索引重建或缩略图生成异常缓慢
- **索引**：大相册（万级以上照片）首次扫描需要较长时间，请保持后台运行。
- **并发**：检查 `NUM_WORKERS`。在 CPU 核心充足的情况下可适当调大该值；若内存紧张（<2G），请减小该值以避免 OOM。

### 6. PWA 安装失败 / 离线功能不可用
- **环境**：PWA 要求必须在 **HTTPS** 环境（或 `localhost` 开发环境）下运行。
- **证书**：如果使用 Nginx 代理，请确保配置了正确的 SSL 证书。

---

## 🤖 功能异常排查

### 7. AI 识图无响应或报错
- **网络**：检查服务器是否能正常访问 OneAPI 或大模型服务商。
- **配置**：核查 `AI_DAILY_LIMIT` 和 API Key。
- **微服务**：确保 AI 微服务容器 (端口 13001) 状态为 `online`。

### 8. 视频播放异常（黑屏、无法拖动）
- **依赖**：确保 Docker 环境内 `ffmpeg` 可用。
- **格式**：Photonix 会尝试生成 HLS 流。检查 `/data/thumbs/hls` 目录下是否有生成的 `.m3u8` 和 `.ts` 文件。
- **Nginx**：如果使用了 Nginx，请参考 [Nginx 配置](./nginx.md) 禁用 `proxy_buffering`。

### 9. 搜索无结果
- **状态**：可能索引尚未建立完成。请在“系统维护”面板查看索引进度。
- **分词**：Photonix 支持中英文分词，如果关键词过短，尝试输入更明确的描述。

---

## 🔒 权限与写操作纠纷

### 10. 相册删除提示“权限不足”
- **症结**：容器内的 Node 用户对宿主机挂载目录没有写入权限。
- **解决**：
    1. 确保 NFS 挂载选项没有启用 `root_squash` 或 `read-only`。
    2. 使用 `sudo chown -R 1000:1000` 批量修改目录及其子目录的权限。
    3. 确认挂载的 `.tmp` 目录也具备写权限，否则视频转码会失败。

### 11. 数据库锁定 (SQLITE_BUSY)
- **解决**：Photonix 已采用三库分离来缓解。如果仍然出现，请检查宿主机磁盘 I/O 是否因大量下载或系统备份而严重负载。

---

> [!TIP]
> 如果问题依然无法解决，可以结合“管理员设置 -> 系统维护”中的“控制台历史”及 [数据库维护指南](../backend/db/README.md) 进行深度定位。
