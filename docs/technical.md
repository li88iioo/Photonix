# 技术实现细节

本文档深入探讨 Photonix 的底层架构与核心服务的技术实现。

---

## 🏗️ AI 内存微服务 (AI Engine)
AI 功能不再依赖外部独立进程，而是作为内存常驻服务运行：

- **自适应并发控制**：默认并发 2，最大 3。根据系统 `loadavg` 和内存压力动态缩减或扩大。
- **Vision Probe (视觉探测)**：内置启发式算法 + 实时采样探针。在拉取模型列表时，通过发送一个 1x1 像素的 Base64 图片探测 API 是否真实支持 Vision 能力，解决 OneAPI/多模型转发器中的模型降级识别问题。
- **智能预处理**：由 Sharp 驱动。所有输入图片在发送至 LLM 前，均会被等比缩放至 1024px 并转换为 Quality 70 的 JPEG，严格控制流量开销并符合模型输入规范。
- **任务防抖与去重**：利用 Redis 对相同路径的任务进行签名比对，避免在极短时间内重复请求昂贵的视觉 API。

---

## 🧵 高性能 Worker 线程池
Photonix 采用多线程模型处理计算密集型任务：

### 1. 索引线程 (Indexing Worker)
- **架构**：全量扫描 + 增量更新。支持“断点续索引”。
- **搜索优化**：集成 SQLite FTS5。采用 N-gram 算法处理中文搜索，确保“部分匹配”也能精准召回结果。
- **元数据缓存**：图片宽高尺寸读取后，会同步缓存至 Redis (TTL 1h) 和本地 LRU Map，后续索引或显示相册封面时无需二次读取磁盘。
- **相册封面预计算**：维护独立的 `album_covers` 表。按照 `mtime DESC` 自动递归为所有层级的相册指定一张最新的图片作为封面，彻底根治运行时实时扫描导致的重负载。

### 2. 缩略图线程 (Thumbnail Worker)
- **自适应质量控制**：根据原始像素数动态调整 WebP 质量（高分辨率使用更低质量，平衡体积）。
- **安全降级模式**：若 Sharp 在标准模式下处理图片失败（如元数据损坏），Worker 将自动切换到 Safe Mode（忽略错误、降低质量、强转 WebP），以确保 UI 最终能显示占位图而非空白。
- **视频截帧**：利用 FFmpeg 在视频总时长的 10% 处截取，兼顾视频开头黑场与读取效率。

### 3. 视频流处理器 (Video Processor)
- **HLS 多码率方案**：采用 FFmpeg 生成 480p 和 720p 两种自适应码率流。
- **资源感知调度**：视频压制是 CPU 杀手。处理器每 30 秒进行一次健康检查，若 RSS 内存超过系统 60% 或负载过高，将自动暂停队列并触发 `global.gc()`。
- **旋转自动矫正**：自动识别移动端拍摄视频的 `Rotate` 标记或 `Display Matrix`，在压制 HLS 过程中应用 `transpose` 滤镜，确保 Web 端播放不翻转。

---

## 💾 数据存储策略

### 多数据库隔离
为了消除 SQLite 的 `SQLITE_BUSY` 锁争用：
- **`gallery.db`**：存储物理文件索引与搜索数据（高频写）。
- **`settings.db`**：存储系统配置与用户偏好（低频写，高安全性）。
- **`index.db`**：存储 AI 处理结果、下载历史与缓存元数据（中频写）。

### Redis 缓存层
- **持久化层**：缓存 API 响应、AI 任务状态。
- **流控层**：管理各接口的限流步长、防爆破计数。
- **消息层**：协调不同 Worker 与主线程之间的状态同步。
